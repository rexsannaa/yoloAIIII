options: [
                        'Maria never takes risks.',
                        'Maria takes risks.',
                        'Maria is not an entrepreneur.',
                        'Maria is unsuccessful.'
                    ],
                    correct: 1,
                    ability: 'reasoning',
                    explanation: 'æ ¹æ“šä¸‰æ®µè«–é‚è¼¯ï¼šæ‰€æœ‰æˆåŠŸä¼æ¥­å®¶éƒ½æœƒå†’éšª â†’ ç‘ªéº—äºæ˜¯æˆåŠŸä¼æ¥­å®¶ â†’ ç‘ªéº—äºæœƒå†’éšªã€‚'
                },
                {
                    type: 'comprehension',
                    level: 'B2',
                    question: 'é–±è®€ä¸¦ç†è§£éš±å«æ„ç¾©ï¼š\n"While the new policy appears beneficial on the surface, critics argue that it may have unintended consequences in the long run."\né€™æ®µè©±æš—ç¤ºä»€éº¼ï¼Ÿ',
                    options: [
                        'æ–°æ”¿ç­–è‚¯å®šæ˜¯å¥½çš„',
                        'æ–°æ”¿ç­–è¡¨é¢çœ‹èµ·ä¾†å¥½ä½†å¯èƒ½æœ‰éš±è—å•é¡Œ',
                        'æ‰¹è©•è€…å®Œå…¨åå°æ–°æ”¿ç­–',
                        'æ–°æ”¿ç­–å·²ç¶“é€ æˆäº†å•é¡Œ'
                    ],
                    correct: 1,
                    ability: 'comprehension',
                    explanation: 'é—œéµè© "appears beneficial on the surface" å’Œ "unintended consequences" è¡¨æ˜æ”¿ç­–è¡¨é¢æœ‰ç›Šä½†å¯èƒ½éš±è—å•é¡Œã€‚'
                }
            ],
            
            // C1ç´šåˆ¥é¡Œç›®
            C1: [
                {
                    type: 'vocabulary',
                    level: 'C1',
                    question: 'é¸æ“‡æœ€ç²¾ç¢ºçš„è©èªï¼š\n"The politician\'s speech was full of ___ statements that could be interpreted in multiple ways."',
                    options: ['clear', 'ambiguous', 'simple', 'direct'],
                    correct: 1,
                    ability: 'vocabulary',
                    explanation: '"Ambiguous" æ„æ€æ˜¯æ¨¡ç³Šä¸æ¸…çš„ã€å¯ä»¥å¤šç¨®ç†è§£çš„ï¼Œæœ€ç¬¦åˆèªå¢ƒã€‚'
                },
                {
                    type: 'reasoning',
                    level: 'C1',
                    question: 'åˆ†æè¤‡é›œæƒ…æ³ï¼š\n"The correlation between social media usage and depression among teenagers is well-documented. However, establishing causation remains challenging due to numerous confounding variables."\né€™æ®µè©±çš„æ ¸å¿ƒè«–é»æ˜¯ï¼š',
                    options: [
                        'ç¤¾äº¤åª’é«”ç›´æ¥å°è‡´é’å°‘å¹´æŠ‘é¬±',
                        'ç¤¾äº¤åª’é«”å’ŒæŠ‘é¬±æœ‰é—œè¯ï¼Œä½†å› æœé—œä¿‚é›£ä»¥ç¢ºå®š',
                        'é’å°‘å¹´æŠ‘é¬±èˆ‡ç¤¾äº¤åª’é«”ç„¡é—œ',
                        'ç ”ç©¶çµæœä¸å¯ä¿¡'
                    ],
                    correct: 1,
                    ability: 'reasoning',
                    explanation: 'å€åˆ†ç›¸é—œæ€§(correlation)å’Œå› æœæ€§(causation)æ˜¯é«˜ç´šå­¸è¡“é–±è®€çš„é‡è¦æŠ€èƒ½ã€‚'
                },
                {
                    type: 'comprehension',
                    level: 'C1',
                    question: 'ç†è§£å­¸è¡“æ–‡æœ¬ï¼š\n"The paradigm shift in renewable energy adoption has been precipitated by a confluence of technological advances, policy incentives, and changing consumer preferences."\n"precipitated by a confluence of" çš„æ„æ€æ˜¯ï¼š',
                    options: [
                        'è¢«é˜»æ­¢ç”±æ–¼',
                        'è¢«åŠ é€Ÿç”±æ–¼å¤šç¨®å› ç´ çš„åŒ¯èš',
                        'è¢«ç°¡åŒ–é€šé',
                        'è¢«æ¨é²å› ç‚º'
                    ],
                    correct: 1,
                    ability: 'comprehension',
                    explanation: '"Precipitated by a confluence of" æ„æ€æ˜¯ç”±å¤šç¨®å› ç´ çš„åŒ¯èšè€Œä¿ƒæˆ/åŠ é€Ÿã€‚'
                }
            ],
            
            // C2ç´šåˆ¥é¡Œç›®
            C2: [
                {
                    type: 'vocabulary',
                    level: 'C2',
                    question: 'é¸æ“‡èªç¾©æœ€ç²¾ç¢ºçš„è©èªï¼š\n"Her argument was so ___ that even her opponents had to acknowledge its validity."',
                    options: ['loud', 'cogent', 'popular', 'lengthy'],
                    correct: 1,
                    ability: 'vocabulary',
                    explanation: '"Cogent" æ„æ€æ˜¯æœ‰èªªæœåŠ›çš„ã€ä»¤äººä¿¡æœçš„ï¼Œæ˜¯é«˜ç´šè©å½™ã€‚'
                },
                {
                    type: 'reasoning',
                    level: 'C2',
                    question: 'åˆ†æè¤‡é›œè«–è­‰ï¼š\n"While the author\'s thesis is intellectually provocative, the paucity of empirical evidence undermines the credibility of his conclusions, rendering them more speculative than substantive."\nä½œè€…çš„è§€é»æ˜¯ï¼š',
                    options: [
                        'è«–æ–‡åœ¨æ™ºåŠ›ä¸Šå…·æœ‰æŒ‘æˆ°æ€§ä¸”è­‰æ“šå……åˆ†',
                        'è«–æ–‡è§€é»æœ‰è¶£ä½†ç¼ºä¹å¯¦è­‰æ”¯æŒï¼Œæ›´åƒæ¨æ¸¬',
                        'è«–æ–‡å®Œå…¨æ²’æœ‰åƒ¹å€¼',
                        'è«–æ–‡çš„çµè«–å®Œå…¨æ­£ç¢º'
                    ],
                    correct: 1,
                    ability: 'reasoning',
                    explanation: 'é—œéµåœ¨æ–¼ç†è§£ "paucity of empirical evidence" (ç¼ºä¹å¯¦è­‰è­‰æ“š) å’Œ "speculative than substantive" (æ¨æ¸¬æ€§å¤šæ–¼å¯¦è³ªæ€§)ã€‚'
                },
                {
                    type: 'comprehension',
                    level: 'C2',
                    question: 'ç†è§£å¾®å¦™èªç¾©å·®ç•°ï¼š\n"The politician\'s ostensibly magnanimous gesture was, in fact, a calculated maneuver designed to rehabilitate his tarnished reputation."\né€™å¥è©±çš„å«ç¾©æ˜¯ï¼š',
                    options: [
                        'æ”¿æ²»å®¶çœŸèª åœ°åšäº†å¥½äº‹',
                        'æ”¿æ²»å®¶è¡¨é¢æ…·æ…¨å¯¦å‰‡åˆ¥æœ‰ç”¨å¿ƒ',
                        'æ”¿æ²»å®¶çš„è²è­½å¾ˆå¥½',
                        'æ”¿æ²»å®¶çš„è¡Œç‚ºå¾ˆè‡ªç„¶'
                    ],
                    correct: 1,
                    ability: 'comprehension',
                    explanation: '"Ostensibly magnanimous" (è¡¨é¢æ…·æ…¨) èˆ‡ "calculated maneuver" (ç²¾å¿ƒç­–åŠƒçš„æ‰‹æ®µ) å½¢æˆå°æ¯”ã€‚'
                }
            ]
        };
    }
    
    /**
     * é–‹å§‹åˆ†ç´šæ¸¬é©—
     */
    startAssessment() {
        console.log('ğŸ¯ é–‹å§‹CEFRåˆ†ç´šæ¸¬é©—');
        
        // éš±è—ä»‹ç´¹ï¼Œé¡¯ç¤ºæ¸¬é©—
        document.querySelector('.assessment-intro').style.display = 'none';
        document.querySelector('.level-overview').style.display = 'none';
        document.querySelector('.assessment-test').style.display = 'block';
        
        // é‡ç½®æ¸¬é©—ç‹€æ…‹
        this.resetAssessment();
        
        // é¸æ“‡æ¸¬é©—é¡Œç›®
        this.selectQuestions();
        
        // é–‹å§‹è¨ˆæ™‚
        this.testStartTime = Date.now();
        this.isTestActive = true;
        
        // é¡¯ç¤ºç¬¬ä¸€é¡Œ
        this.showQuestion(0);
        
        // æ›´æ–°é€²åº¦
        this.updateProgress();
    }
    
    /**
     * é‡ç½®æ¸¬é©—ç‹€æ…‹
     */
    resetAssessment() {
        this.currentQuestion = 0;
        this.responses = [];
        this.abilities = {
            vocabulary: 0,
            grammar: 0,
            comprehension: 0,
            reasoning: 0
        };
        this.testStartTime = null;
        this.isTestActive = false;
        this.selectedQuestions = [];
    }
    
    /**
     * é¸æ“‡æ¸¬é©—é¡Œç›®
     */
    selectQuestions() {
        const allQuestions = [];
        
        // å¾æ¯å€‹ç´šåˆ¥é¸æ“‡é¡Œç›®ï¼Œç¢ºä¿å¹³è¡¡
        Object.keys(this.questionBank).forEach(level => {
            const levelQuestions = this.questionBank[level];
            // æ¯å€‹ç´šåˆ¥é¸2-3é¡Œ
            const selectedCount = level === 'A1' || level === 'A2' ? 3 : 2;
            const shuffled = this.shuffleArray([...levelQuestions]);
            allQuestions.push(...shuffled.slice(0, selectedCount));
        });
        
        // æ‰“äº‚é¡Œç›®é †åºä¸¦é¸æ“‡ç¸½å…±15é¡Œ
        this.selectedQuestions = this.shuffleArray(allQuestions).slice(0, this.totalQuestions);
        
        console.log('ğŸ“‹ å·²é¸æ“‡æ¸¬é©—é¡Œç›®:', this.selectedQuestions.length, 'é¡Œ');
    }
    
    /**
     * é¡¯ç¤ºé¡Œç›®
     */
    showQuestion(questionIndex) {
        if (questionIndex < 0 || questionIndex >= this.selectedQuestions.length) {
            return;
        }
        
        const question = this.selectedQuestions[questionIndex];
        
        // æ›´æ–°é¡Œç›®å…§å®¹
        const questionText = document.getElementById('questionText');
        const optionsContainer = document.getElementById('optionsContainer');
        const questionTypeElement = document.querySelector('.question-type');
        const questionLevelElement = document.querySelector('.question-level');
        
        if (questionText) {
            questionText.textContent = question.question;
        }
        
        if (questionTypeElement) {
            const typeNames = {
                'vocabulary': 'è©å½™æ¸¬è©¦',
                'grammar': 'èªæ³•æ¸¬è©¦',
                'comprehension': 'ç†è§£æ¸¬è©¦',
                'reasoning': 'é‚è¼¯æ¨ç†'
            };
            questionTypeElement.textContent = typeNames[question.type] || question.type;
        }
        
        if (questionLevelElement) {
            questionLevelElement.textContent = question.level;
        }
        
        // ç”Ÿæˆé¸é …
        if (optionsContainer) {
            optionsContainer.innerHTML = '';
            question.options.forEach((option, index) => {
                const optionLabel = document.createElement('label');
                optionLabel.className = 'option-label';
                optionLabel.innerHTML = `
                    <input type="radio" name="question-answer" value="${index}">
                    <span class="option-text">${option}</span>
                `;
                optionsContainer.appendChild(optionLabel);
            });
            
            // å¦‚æœå·²ç¶“å›ç­”éï¼Œæ¢å¾©é¸æ“‡
            const previousAnswer = this.responses[questionIndex];
            if (previousAnswer !== undefined) {
                const radioButton = optionsContainer.querySelector(`input[value="${previousAnswer}"]`);
                if (radioButton) {
                    radioButton.checked = true;
                }
            }
        }
        
        // æ›´æ–°æŒ‰éˆ•ç‹€æ…‹
        this.updateNavigationButtons();
        
        // æ›´æ–°é€²åº¦
        this.updateProgress();
    }
    
    /**
     * ä¸Šä¸€é¡Œ
     */
    previousQuestion() {
        if (this.currentQuestion > 0) {
            // å„²å­˜ç•¶å‰ç­”æ¡ˆ
            this.saveCurrentAnswer();
            
            this.currentQuestion--;
            this.showQuestion(this.currentQuestion);
        }
    }
    
    /**
     * ä¸‹ä¸€é¡Œ
     */
    nextQuestion() {
        // å„²å­˜ç•¶å‰ç­”æ¡ˆ
        this.saveCurrentAnswer();
        
        if (this.currentQuestion < this.selectedQuestions.length - 1) {
            this.currentQuestion++;
            this.showQuestion(this.currentQuestion);
        }
    }
    
    /**
     * å„²å­˜ç•¶å‰ç­”æ¡ˆ
     */
    saveCurrentAnswer() {
        const selectedOption = document.querySelector('input[name="question-answer"]:checked');
        if (selectedOption) {
            this.responses[this.currentQuestion] = parseInt(selectedOption.value);
        }
    }
    
    /**
     * æ›´æ–°å°èˆªæŒ‰éˆ•ç‹€æ…‹
     */
    updateNavigationButtons() {
        const prevBtn = document.getElementById('prevQuestion');
        const nextBtn = document.getElementById('nextQuestion');
        const finishBtn = document.getElementById('finishTest');
        
        if (prevBtn) {
            prevBtn.disabled = this.currentQuestion === 0;
        }
        
        // æª¢æŸ¥æ˜¯å¦ç‚ºæœ€å¾Œä¸€é¡Œ
        const isLastQuestion = this.currentQuestion === this.selectedQuestions.length - 1;
        
        if (nextBtn && finishBtn) {
            if (isLastQuestion) {
                nextBtn.style.display = 'none';
                finishBtn.style.display = 'inline-flex';
            } else {
                nextBtn.style.display = 'inline-flex';
                finishBtn.style.display = 'none';
            }
        }
    }
    
    /**
     * æ›´æ–°é€²åº¦é¡¯ç¤º
     */
    updateProgress() {
        const progressFill = document.querySelector('.assessment-test .progress-fill');
        const progressText = document.querySelector('.assessment-test .progress-text');
        
        const progress = ((this.currentQuestion + 1) / this.selectedQuestions.length) * 100;
        
        if (progressFill) {
            progressFill.style.width = `${progress}%`;
        }
        
        if (progressText) {
            progressText.textContent = `${this.currentQuestion + 1} / ${this.selectedQuestions.length}`;
        }
    }
    
    /**
     * å®Œæˆæ¸¬é©—
     */
    finishAssessment() {
        // å„²å­˜æœ€å¾Œä¸€é¡Œç­”æ¡ˆ
        this.saveCurrentAnswer();
        
        // æª¢æŸ¥æ˜¯å¦æ‰€æœ‰é¡Œç›®éƒ½å·²å›ç­”
        const unansweredQuestions = this.selectedQuestions.length - this.responses.filter(r => r !== undefined).length;
        
        if (unansweredQuestions > 0) {
            const confirmFinish = confirm(`é‚„æœ‰ ${unansweredQuestions} é¡Œæœªå›ç­”ï¼Œç¢ºå®šè¦å®Œæˆæ¸¬é©—å—ï¼Ÿ`);
            if (!confirmFinish) {
                return;
            }
        }
        
        // è¨ˆç®—çµæœ
        this.calculateResults();
        
        // é¡¯ç¤ºçµæœ
        this.showResults();
        
        console.log('âœ… CEFRåˆ†ç´šæ¸¬é©—å®Œæˆ');
    }
    
    /**
     * è¨ˆç®—æ¸¬é©—çµæœ
     */
    calculateResults() {
        let totalScore = 0;
        let abilityScores = {
            vocabulary: { correct: 0, total: 0 },
            grammar: { correct: 0, total: 0 },
            comprehension: { correct: 0, total: 0 },
            reasoning: { correct: 0, total: 0 }
        };
        
        // è¨ˆç®—å„é¡Œå¾—åˆ†
        this.selectedQuestions.forEach((question, index) => {
            const userAnswer = this.responses[index];
            const isCorrect = userAnswer === question.correct;
            
            if (isCorrect) {
                totalScore++;
                abilityScores[question.ability].correct++;
            }
            abilityScores[question.ability].total++;
        });
        
        // è¨ˆç®—å„èƒ½åŠ›ç¶­åº¦ç™¾åˆ†æ¯”
        Object.keys(abilityScores).forEach(ability => {
            const { correct, total } = abilityScores[ability];
            this.abilities[ability] = total > 0 ? Math.round((correct / total) * 100) : 0;
        });
        
        // è¨ˆç®—ç¸½é«”å¾—åˆ†ç‡
        const overallScore = Math.round((totalScore / this.selectedQuestions.length) * 100);
        
        // æ ¹æ“šå¾—åˆ†ç¢ºå®šCEFRç´šåˆ¥
        const cefrLevel = this.determineCEFRLevel(overallScore, this.abilities);
        
        // å„²å­˜çµæœåˆ°æ‡‰ç”¨ç¨‹å¼ç‹€æ…‹
        this.app.setUserLevel(cefrLevel, this.abilities);
        
        console.log('ğŸ“Š æ¸¬é©—çµæœ:', {
            level: cefrLevel,
            overallScore: overallScore,
            abilities: this.abilities
        });
    }
    
    /**
     * ç¢ºå®šCEFRç´šåˆ¥
     */
    determineCEFRLevel(overallScore, abilities) {
        // ç¶œåˆè€ƒæ…®ç¸½åˆ†å’Œå„èƒ½åŠ›ç¶­åº¦
        const avgAbilityScore = Object.values(abilities).reduce((sum, score) => sum + score, 0) / 4;
        const finalScore = (overallScore + avgAbilityScore) / 2;
        
        // ç´šåˆ¥åˆ¤å®šæ¨™æº–
        if (finalScore >= 90) return 'C2';
        if (finalScore >= 80) return 'C1';
        if (finalScore >= 70) return 'B2';
        if (finalScore >= 60) return 'B1';
        if (finalScore >= 50) return 'A2';
        return 'A1';
    }
    
    /**
     * é¡¯ç¤ºæ¸¬é©—çµæœ
     */
    showResults() {
        // éš±è—æ¸¬é©—ï¼Œé¡¯ç¤ºçµæœ
        document.querySelector('.assessment-test').style.display = 'none';
        document.querySelector('.assessment-result').style.display = 'block';
        
        // æ›´æ–°ç´šåˆ¥é¡¯ç¤º
        const levelBadge = document.getElementById('finalLevelBadge');
        const levelTitle = document.getElementById('levelTitle');
        const levelDescription = document.getElementById('levelDescription');
        
        const levelInfo = this.app.cefrLevels[this.app.userLevel];
        
        if (levelBadge) {
            levelBadge.textContent = this.app.userLevel;
            levelBadge.className = `final-level-badge ${this.app.userLevel.toLowerCase()}`;
        }
        
        if (levelTitle) {
            levelTitle.textContent = levelInfo.name;
        }
        
        if (levelDescription) {
            levelDescription.textContent = `æ‚¨èƒ½${levelInfo.description}`;
        }
        
        // æ›´æ–°èƒ½åŠ›åˆ†æ•¸é¡¯ç¤º
        this.updateAbilityDisplay();
        
        // ç”Ÿæˆå­¸ç¿’å»ºè­°
        this.generateRecommendations();
        
        // ç”Ÿæˆèƒ½åŠ›é›·é”åœ–
        this.generateAbilityRadar();
    }
    
    /**
     * æ›´æ–°èƒ½åŠ›åˆ†æ•¸é¡¯ç¤º
     */
    updateAbilityDisplay() {
        const abilityElements = {
            vocabulary: document.getElementById('vocabScore'),
            grammar: document.getElementById('grammarScore'),
            comprehension: document.getElementById('comprehensionScore'),
            reasoning: document.getElementById('reasoningScore')
        };
        
        Object.keys(this.abilities).forEach(ability => {
            const element = abilityElements[ability];
            const fillElement = document.querySelector(`.ability-fill[data-ability="${ability}"]`);
            
            if (element) {
                element.textContent = `${this.abilities[ability]}%`;
            }
            
            if (fillElement) {
                setTimeout(() => {
                    fillElement.style.width = `${this.abilities[ability]}%`;
                }, 500);
            }
        });
    }
    
    /**
     * ç”Ÿæˆå­¸ç¿’å»ºè­°
     */
    generateRecommendations() {
        const recommendationsList = document.getElementById('recommendationList');
        if (!recommendationsList) return;
        
        const recommendations = this.generatePersonalizedRecommendations();
        
        recommendationsList.innerHTML = '';
        recommendations.forEach((rec, index) => {
            const recElement = document.createElement('div');
            recElement.className = 'recommendation-item';
            recElement.innerHTML = `
                <div class="recommendation-icon">${index + 1}</div>
                <div class="recommendation-text">${rec}</div>
            `;
            recommendationsList.appendChild(recElement);
        });
    }
    
    /**
     * ç”Ÿæˆå€‹æ€§åŒ–å»ºè­°
     */
    generatePersonalizedRecommendations() {
        const level = this.app.userLevel;
        const abilities = this.abilities;
        const recommendations = [];
        
        // æ ¹æ“šç´šåˆ¥æä¾›åŸºç¤å»ºè­°
        const levelRecommendations = {
            'A1': [
                'å°ˆæ³¨æ–¼åŸºç¤è©å½™å­¸ç¿’ï¼Œå»ºè­°å¾æ—¥å¸¸ç”Ÿæ´»ç”¨èªé–‹å§‹',
                'ç·´ç¿’ç°¡å–®çš„èªæ³•çµæ§‹ï¼Œå¦‚ç¾åœ¨å¼å’Œéå»å¼',
                'å¤šè½è‹±èªå…’æ­Œå’Œç°¡å–®å°è©±ä¾†åŸ¹é¤Šèªæ„Ÿ'
            ],
            'A2': [
                'æ“´å±•è©å½™é‡åˆ°1000-2000å€‹å¸¸ç”¨å–®è©',
                'å­¸ç¿’åŸºç¤èªæ³•çµæ§‹ï¼ŒåŒ…æ‹¬ç–‘å•å¥å’Œå¦å®šå¥',
                'å˜—è©¦ç°¡å–®çš„è‹±èªé–±è®€ææ–™ï¼Œå¦‚å…’ç«¥æ•…äº‹'
            ],
            'B1': [
                'å­¸ç¿’2000-3000å€‹å¯¦ç”¨è©å½™ï¼ŒåŒ…æ‹¬æŠ½è±¡æ¦‚å¿µ',
                'æŒæ¡è¤‡é›œèªæ³•ï¼Œå¦‚æ¢ä»¶å¥å’Œè¢«å‹•èªæ…‹',
                'ç·´ç¿’è¡¨é”å€‹äººè§€é»å’Œæè¿°ç¶“æ­·'
            ],
            'B2': [
                'æŒæ¡3000-4000å€‹é€²éšè©å½™',
                'å­¸ç¿’è¤‡é›œèªæ³•çµæ§‹å’Œå„ç¨®æ™‚æ…‹',
                'ç·´ç¿’å­¸è¡“å¯«ä½œå’Œæ­£å¼æ¼”è¬›'
            ],
            'C1': [
                'æ“´å±•åˆ°4000-6000å€‹é«˜ç´šè©å½™',
                'æŒæ¡é«˜ç´šèªæ³•å’Œæ…£ç”¨è¡¨é”',
                'ç·´ç¿’æ‰¹åˆ¤æ€§æ€ç¶­å’Œå­¸è¡“è¨è«–'
            ],
            'C2': [
                'æŒçºŒæ“´å±•å°ˆæ¥­é ˜åŸŸè©å½™',
                'ç²¾ç´°æŒæ¡èªè¨€çš„ç´°å¾®å·®åˆ¥',
                'ç·´ç¿’æ¯èªæ°´å¹³çš„è¡¨é”å’Œå¯«ä½œ'
            ]
        };
        
        // æ·»åŠ ç´šåˆ¥å»ºè­°
        recommendations.push(...levelRecommendations[level]);
        
        // æ ¹æ“šèƒ½åŠ›è–„å¼±ç’°ç¯€æä¾›é‡å°æ€§å»ºè­°
        const weakestAbility = Object.keys(abilities).reduce((min, key) => 
            abilities[key] < abilities[min] ? key : min
        );
        
        const abilityRecommendations = {
            vocabulary: 'å»ºè­°ä½¿ç”¨è¨˜æ†¶å¡ç‰‡æˆ–è©å½™æ‡‰ç”¨ç¨‹å¼åŠ å¼·è©å½™å­¸ç¿’',
            grammar: 'å»ºè­°ç³»çµ±å­¸ç¿’èªæ³•è¦å‰‡ï¼Œå¤šåšèªæ³•ç·´ç¿’é¡Œ',
            comprehension: 'å»ºè­°å¢åŠ é–±è®€é‡ï¼Œå¾ç°¡å–®æ–‡ç« é€æ­¥æå‡åˆ°è¤‡é›œå…§å®¹',
            reasoning: 'å»ºè­°ç·´ç¿’é‚è¼¯æ¨ç†é¡Œï¼ŒåŸ¹é¤Šæ‰¹åˆ¤æ€§æ€ç¶­èƒ½åŠ›'
        };
        
        if (abilities[weakestAbility] < 70) {
            recommendations.push(`æ‚¨çš„${this.getAbilityName(weakestAbility)}éœ€è¦åŠ å¼·ï¼š${abilityRecommendations[weakestAbility]}`);
        }
        
        return recommendations.slice(0, 5); // é™åˆ¶å»ºè­°æ•¸é‡
    }
    
    /**
     * å–å¾—èƒ½åŠ›ä¸­æ–‡åç¨±
     */
    getAbilityName(ability) {
        const names = {
            vocabulary: 'è©å½™æŒæ¡',
            grammar: 'èªæ³•ç†è§£',
            comprehension: 'é–±è®€ç†è§£',
            reasoning: 'é‚è¼¯æ¨ç†'
        };
        return names[ability] || ability;
    }
    
    /**
     * ç”Ÿæˆèƒ½åŠ›é›·é”åœ–
     */
    generateAbilityRadar() {
        const radarContainer = document.getElementById('abilityRadar');
        if (!radarContainer) return;
        
        // å‰µå»ºSVGé›·é”åœ–
        const size = 300;
        const center = size / 2;
        const maxRadius = center - 40;
        
        const svg = document.createElementNS('http://www.w3.org/2000/svg', 'svg');
        svg.setAttribute('width', size);
        svg.setAttribute('height', size);
        svg.setAttribute('viewBox', `0 0 ${size} ${size}`);
        
        // ç¹ªè£½èƒŒæ™¯ç¶²æ ¼
        this.drawRadarGrid(svg, center, maxRadius);
        
        // ç¹ªè£½èƒ½åŠ›æ•¸æ“š
        this.drawAbilityData(svg, center, maxRadius);
        
        // æ·»åŠ æ¨™ç±¤
        this.drawAbilityLabels(svg, center, maxRadius);
        
        radarContainer.innerHTML = '';
        radarContainer.appendChild(svg);
    }
    
    /**
     * ç¹ªè£½é›·é”åœ–ç¶²æ ¼
     */
    drawRadarGrid(svg, center, maxRadius) {
        const levels = 5;
        
        // ç¹ªè£½åŒå¿ƒåœ“
        for (let i = 1; i <= levels; i++) {
            const radius = (maxRadius / levels) * i;
            const circle = document.createElementNS('http://www.w3.org/2000/svg', 'circle');
            circle.setAttribute('cx', center);
            circle.setAttribute('cy', center);
            circle.setAttribute('r', radius);
            circle.setAttribute('fill', 'none');
            circle.setAttribute('stroke', '#e2e8f0');
            circle.setAttribute('stroke-width', '1');
            svg.appendChild(circle);
        }
        
        // ç¹ªè£½è»¸ç·š
        const abilities = Object.keys(this.abilities);
        const angleStep = (2 * Math.PI) / abilities.length;
        
        abilities.forEach((_, index) => {
            const angle = (index * angleStep) - (Math.PI / 2);
            const x = center + Math.cos(angle) * maxRadius;
            const y = center + Math.sin(angle) * maxRadius;
            
            const line = document.createElementNS('http://www.w3.org/2000/svg', 'line');
            line.setAttribute('x1', center);
            line.setAttribute('y1', center);
            line.setAttribute('x2', x);
            line.setAttribute('y2', y);
            line.setAttribute('stroke', '#cbd5e1');
            line.setAttribute('stroke-width', '1');
            svg.appendChild(line);
        });
    }
    
    /**
     * ç¹ªè£½èƒ½åŠ›æ•¸æ“š
     */
    drawAbilityData(svg, center, maxRadius) {
        const abilities = Object.keys(this.abilities);
        const angleStep = (2 * Math.PI) / abilities.length;
        const points = [];
        
        abilities.forEach((ability, index) => {
            const score = this.abilities[ability];
            const radius = (score / 100) * maxRadius;
            const angle = (index * angleStep) - (Math.PI / 2);
            const x = center + Math.cos(angle) * radius;
            const y = center + Math.sin(angle) * radius;
            
            points.push(`${x},${y}`);
            
            // ç¹ªè£½æ•¸æ“šé»
            const point = document.createElementNS('http://www.w3.org/2000/svg', 'circle');
            point.setAttribute('cx', x);
            point.setAttribute('cy', y);
            point.setAttribute('r', '4');
            point.setAttribute('fill', '#3b82f6');
            point.setAttribute('stroke', '#ffffff');
            point.setAttribute('stroke-width', '2');
            svg.appendChild(point);
        });
        
        // ç¹ªè£½é€£æ¥ç·š
        const polygon = document.createElementNS('http://www.w3.org/2000/svg', 'polygon');
        polygon.setAttribute('points', points.join(' '));
        polygon.setAttribute('fill', 'rgba(59, 130, 246, 0.2)');
        polygon.setAttribute('stroke', '#3b82f6');
        polygon.setAttribute('stroke-width', '2');
        svg.appendChild(polygon);
    }
    
    /**
     * ç¹ªè£½èƒ½åŠ›æ¨™ç±¤
     */
    drawAbilityLabels(svg, center, maxRadius) {
        const abilities = Object.keys(this.abilities);
        const abilityNames = {
            vocabulary: 'è©å½™',
            grammar: 'èªæ³•',
            comprehension: 'ç†è§£',
            reasoning: 'æ¨ç†'
        };
        
        const angleStep = (2 * Math.PI) / abilities.length;
        const labelRadius = maxRadius + 20;
        
        abilities.forEach((ability, index) => {
            const angle = (index * angleStep) - (Math.PI / 2);
            const x = center + Math.cos(angle) * labelRadius;
            const y = center + Math.sin(angle) * labelRadius;
            
            const text = document.createElementNS('http://www.w3.org/2000/svg', 'text');
            text.setAttribute('x', x);
            text.setAttribute('y', y);
            text.setAttribute('text-anchor', 'middle');
            text.setAttribute('dominant-baseline', 'middle');
            text.setAttribute('font-size', '12');
            text.setAttribute('font-weight', '500');
            text.setAttribute('fill', '#374151');
            text.textContent = abilityNames[ability];
            svg.appendChild(text);
        });
    }
    
    /**
     * é–‹å§‹å­¸ç¿’æ—…ç¨‹
     */
    startLearningJourney() {
        // åˆ‡æ›åˆ°ä¸‹ä¸€å€‹æ¨¡çµ„
        this.app.switchModule('flashcard');
    }
    
    /**
     * é¡¯ç¤ºç´šåˆ¥è©³æƒ…
     */
    showLevelDetails(level) {
        const levelInfo = this.app.cefrLevels[level];
        if (!levelInfo) return;
        
        // å‰µå»ºè©³æƒ…æ¨¡æ…‹æ¡†
        const modal = document.createElement('div');
        modal.className = 'modal level-detail-modal';
        modal.innerHTML = `
            <div class="modal-content">
                <div class="modal-header">
                    <h3>CEFR ${level} - ${levelInfo.name}</h3>
                    <button class="modal-close">&times;</button>
                </div>
                <div class="modal-body">
                    <div class="level-detail">
                        <div class="level-badge ${level.toLowerCase()}">${level}</div>
                        <p><strong>èƒ½åŠ›æè¿°ï¼š</strong>${levelInfo.description}</p>
                        <p><strong>è©å½™ç¯„åœï¼š</strong>${levelInfo.vocabularyRange[0]}-${levelInfo.vocabularyRange[1]}å€‹å–®è©</p>
                        <div class="criteria-list">
                            <h4>è©•ä¼°æ¨™æº–ï¼š</h4>
                            <ul>
                                <li>è©å½™æŒæ¡ï¼š${levelInfo.criteria.vocabulary}+ å€‹å–®è©</li>
                                <li>èªæ³•ç†è§£ï¼š${levelInfo.criteria.grammar} ç´šåˆ¥</li>
                                <li>é–±è®€ç†è§£ï¼š${levelInfo.criteria.comprehension} æ°´å¹³</li>
                            </ul>
                        </div>
                    </div>
                </div>
            </div>
        `;
        
        document.body.appendChild(modal);
        setTimeout(() => modal.classList.add('show'), 10);
        
        // é—œé–‰äº‹ä»¶
        const closeBtn = modal.querySelector('.modal-close');
        closeBtn.addEventListener('click', () => {
            modal.classList.remove('show');
            setTimeout(() => document.body.removeChild(modal), 300);
        });
        
        modal.addEventListener('click', (e) => {
            if (e.target === modal) {
                modal.classList.remove('show');
                setTimeout(() => document.body.removeChild(modal), 300);
            }
        });
    }
    
    /**
     * æ¨¡çµ„é¡¯ç¤ºæ™‚çš„å›èª¿
     */
    onShow() {
        // æª¢æŸ¥æ˜¯å¦å·²å®Œæˆæ¸¬é©—
        if (this.app.userLevel) {
            // å·²å®Œæˆæ¸¬é©—ï¼Œé¡¯ç¤ºçµæœ
            document.querySelector('.assessment-intro').style.display = 'none';
            document.querySelector('.level-overview').style.display = 'none';
            document.querySelector('.assessment-test').style.display = 'none';
            document.querySelector('.assessment-result').style.display = 'block';
            
            this.showResults();
        } else {
            // å°šæœªå®Œæˆæ¸¬é©—ï¼Œé¡¯ç¤ºä»‹ç´¹
            document.querySelector('.assessment-intro').style.display = 'block';
            document.querySelector('.level-overview').style.display = 'grid';
            document.querySelector('.assessment-test').style.display = 'none';
            document.querySelector('.assessment-result').style.display = 'none';
        }
    }
    
    // ==========================================
    // å·¥å…·å‡½æ•¸
    // ==========================================
    
    /**
     * æ´—ç‰Œé™£åˆ—
     */
    shuffleArray(array) {
        const shuffled = [...array];
        for (let i = shuffled.length - 1; i > 0; i--) {
            const j = Math.floor(Math.random() * (i + 1));
            [shuffled[i], shuffled[j]] = [shuffled[j], shuffled[i]];
        }
        return shuffled;
    }
    
    /**
     * æ ¼å¼åŒ–æ™‚é–“
     */
    formatTime(milliseconds) {
        const seconds = Math.floor(milliseconds / 1000);
        const minutes = Math.floor(seconds / 60);
        const remainingSeconds = seconds % 60;
        return `${minutes}:${remainingSeconds.toString().padStart(2, '0')}`;
    }
    
    /**
     * è¨ˆç®—æ¸¬é©—çµ±è¨ˆ
     */
    getTestStatistics() {
        const testDuration = this.testStartTime ? Date.now() - this.testStartTime : 0;
        const answeredQuestions = this.responses.filter(r => r !== undefined).length;
        const correctAnswers = this.selectedQuestions.filter((q, i) => 
            this.responses[i] === q.correct
        ).length;
        
        return {
            duration: testDuration,
            totalQuestions: this.selectedQuestions.length,
            answeredQuestions: answeredQuestions,
            correctAnswers: correctAnswers,
            accuracy: answeredQuestions > 0 ? (correctAnswers / answeredQuestions) * 100 : 0
        };
    }
    
    /**
     * åŒ¯å‡ºæ¸¬é©—çµæœ
     */
    exportResults() {
        const stats = this.getTestStatistics();
        const results = {
            timestamp: new Date().toISOString(),
            userLevel: this.app.userLevel,
            abilities: this.abilities,
            statistics: stats,
            responses: this.responses.map((response, index) => ({
                questionIndex: index,
                question: this.selectedQuestions[index],
                userAnswer: response,
                correct: response === this.selectedQuestions[index].correct
            }))
        };
        
        return results;
    }
    
    /**
     * é‡æ–°æ¸¬é©—
     */
    retakeAssessment() {
        // ç¢ºèªé‡æ–°æ¸¬é©—
        const confirmRetake = confirm('ç¢ºå®šè¦é‡æ–°é€²è¡ŒCEFRåˆ†ç´šæ¸¬é©—å—ï¼Ÿé€™å°‡æ¸…é™¤ç›®å‰çš„çµæœã€‚');
        if (!confirmRetake) return;
        
        // é‡ç½®æ‰€æœ‰ç‹€æ…‹
        this.resetAssessment();
        this.app.userLevel = null;
        this.app.updateLevelDisplay('æœªæ¸¬è©¦');
        
        // å›åˆ°æ¸¬é©—é–‹å§‹é é¢
        document.querySelector('.assessment-result').style.display = 'none';
        document.querySelector('.assessment-intro').style.display = 'block';
        document.querySelector('.level-overview').style.display = 'grid';
        
        console.log('ğŸ”„ é‡æ–°é–‹å§‹CEFRåˆ†ç´šæ¸¬é©—');
    }
    
    /**
     * æ¸…ç†è³‡æº
     */
    destroy() {
        // åœæ­¢ä»»ä½•é€²è¡Œä¸­çš„æ¸¬é©—
        this.isTestActive = false;
        
        // æ¸…ç†äº‹ä»¶ç›£è½å™¨
        // (äº‹ä»¶ç›£è½å™¨æœƒåœ¨ä¸»æ‡‰ç”¨ç¨‹å¼æ¸…ç†æ™‚ä¸€ä½µè™•ç†)
        
        console.log('ğŸ—‘ï¸ Assessmentæ¨¡çµ„è³‡æºæ¸…ç†å®Œæˆ');
    }
}

// ç¢ºä¿é¡åˆ¥åœ¨å…¨åŸŸç¯„åœå…§å¯ç”¨
window.AssessmentModule = AssessmentModule;/**
 * assessment.js - CEFRåˆ†ç´šæ¸¬é©—ç³»çµ±
 * è² è²¬ï¼šæ°´å¹³è©•ä¼°ã€ç´šåˆ¥åˆ¤å®šã€èƒ½åŠ›åˆ†æã€å€‹æ€§åŒ–å»ºè­°
 */

class AssessmentModule {
    constructor(app) {
        this.app = app;
        this.currentQuestion = 0;
        this.totalQuestions = 15;
        this.responses = [];
        this.abilities = {
            vocabulary: 0,    // è©å½™æŒæ¡åº¦ (30%)
            grammar: 0,       // èªæ³•ç†è§£åº¦ (25%)
            comprehension: 0, // é–±è®€ç†è§£åº¦ (25%)
            reasoning: 0      // é‚è¼¯æ¨ç†åº¦ (20%)
        };
        this.testStartTime = null;
        this.isTestActive = false;
        
        // CEFRæ¸¬é©—é¡Œåº«
        this.questionBank = this.generateQuestionBank();
        this.selectedQuestions = [];
        
        this.init();
    }
    
    /**
     * åˆå§‹åŒ–æ¸¬é©—æ¨¡çµ„
     */
    init() {
        console.log('ğŸ“ CEFRåˆ†ç´šæ¸¬é©—æ¨¡çµ„åˆå§‹åŒ–');
        this.setupEventListeners();
        this.resetAssessment();
    }
    
    /**
     * è¨­å®šäº‹ä»¶ç›£è½å™¨
     */
    setupEventListeners() {
        // é–‹å§‹æ¸¬é©—æŒ‰éˆ•
        const startBtn = document.getElementById('startAssessment');
        if (startBtn) {
            startBtn.addEventListener('click', () => this.startAssessment());
        }
        
        // æ¸¬é©—æ§åˆ¶æŒ‰éˆ•
        const prevBtn = document.getElementById('prevQuestion');
        const nextBtn = document.getElementById('nextQuestion');
        const finishBtn = document.getElementById('finishTest');
        
        if (prevBtn) prevBtn.addEventListener('click', () => this.previousQuestion());
        if (nextBtn) nextBtn.addEventListener('click', () => this.nextQuestion());
        if (finishBtn) finishBtn.addEventListener('click', () => this.finishAssessment());
        
        // é–‹å§‹å­¸ç¿’æŒ‰éˆ•
        const startLearningBtn = document.getElementById('startLearning');
        if (startLearningBtn) {
            startLearningBtn.addEventListener('click', () => this.startLearningJourney());
        }
        
        // ç´šåˆ¥å¡ç‰‡é»æ“Š
        const levelCards = document.querySelectorAll('.level-card');
        levelCards.forEach(card => {
            card.addEventListener('click', () => {
                const level = card.dataset.level;
                this.showLevelDetails(level);
            });
        });
    }
    
    /**
     * ç”Ÿæˆæ¸¬é©—é¡Œåº«
     */
    generateQuestionBank() {
        return {
            // A1ç´šåˆ¥é¡Œç›®ï¼ˆåŸºç¤è©å½™å’Œèªæ³•ï¼‰
            A1: [
                {
                    type: 'vocabulary',
                    level: 'A1',
                    question: 'é¸æ“‡ "Hello" çš„æ­£ç¢ºä¸­æ–‡æ„æ€ï¼š',
                    options: ['å†è¦‹', 'ä½ å¥½', 'è¬è¬', 'å°ä¸èµ·'],
                    correct: 1,
                    ability: 'vocabulary',
                    explanation: '"Hello" æ˜¯æœ€åŸºæœ¬çš„è‹±èªå•å€™èªï¼Œæ„æ€æ˜¯"ä½ å¥½"ã€‚'
                },
                {
                    type: 'grammar',
                    level: 'A1',
                    question: 'é¸æ“‡æ­£ç¢ºçš„å¥å­ï¼š',
                    options: [
                        'I am student.',
                        'I am a student.',
                        'I am the student.',
                        'I student am.'
                    ],
                    correct: 1,
                    ability: 'grammar',
                    explanation: '"I am a student" æ˜¯æ­£ç¢ºçš„èªæ³•çµæ§‹ï¼Œéœ€è¦ä½¿ç”¨ä¸å®šå† è© "a"ã€‚'
                },
                {
                    type: 'comprehension',
                    level: 'A1',
                    question: 'é–±è®€å¥å­ï¼š"My name is John." é€™å¥è©±çš„æ„æ€æ˜¯ï¼š',
                    options: ['æˆ‘å–œæ­¡ç´„ç¿°', 'æˆ‘çš„åå­—æ˜¯ç´„ç¿°', 'ç´„ç¿°æ˜¯æˆ‘æœ‹å‹', 'æˆ‘èªè­˜ç´„ç¿°'],
                    correct: 1,
                    ability: 'comprehension',
                    explanation: '"My name is John" ç›´æ¥ç¿»è­¯å°±æ˜¯"æˆ‘çš„åå­—æ˜¯ç´„ç¿°"ã€‚'
                }
            ],
            
            // A2ç´šåˆ¥é¡Œç›®
            A2: [
                {
                    type: 'vocabulary',
                    level: 'A2',
                    question: 'é¸æ“‡ "exciting" çš„æœ€ä½³ä¸­æ–‡ç¿»è­¯ï¼š',
                    options: ['å›°é›£çš„', 'ä»¤äººèˆˆå¥®çš„', 'é‡è¦çš„', 'å±éšªçš„'],
                    correct: 1,
                    ability: 'vocabulary',
                    explanation: '"Exciting" æ„æ€æ˜¯ä»¤äººèˆˆå¥®çš„ã€åˆºæ¿€çš„ã€‚'
                },
                {
                    type: 'grammar',
                    level: 'A2',
                    question: 'é¸æ“‡æ­£ç¢ºçš„éå»å¼ï¼š',
                    options: [
                        'I go to school yesterday.',
                        'I went to school yesterday.',
                        'I going to school yesterday.',
                        'I goed to school yesterday.'
                    ],
                    correct: 1,
                    ability: 'grammar',
                    explanation: '"Go" çš„éå»å¼æ˜¯ "went"ï¼Œæ‰€ä»¥æ­£ç¢ºç­”æ¡ˆæ˜¯ "I went to school yesterday"ã€‚'
                },
                {
                    type: 'reasoning',
                    level: 'A2',
                    question: 'æ ¹æ“šä¸Šä¸‹æ–‡ï¼Œé¸æ“‡æœ€åˆé©çš„è©èªå¡«ç©ºï¼š\n"It\'s raining outside. You should take an ___."',
                    options: ['apple', 'umbrella', 'orange', 'book'],
                    correct: 1,
                    ability: 'reasoning',
                    explanation: 'ä¸‹é›¨å¤©éœ€è¦é›¨å‚˜(umbrella)ï¼Œé€™æ˜¯é‚è¼¯æ¨ç†çš„çµæœã€‚'
                }
            ],
            
            // B1ç´šåˆ¥é¡Œç›®
            B1: [
                {
                    type: 'vocabulary',
                    level: 'B1',
                    question: 'é¸æ“‡èˆ‡ "accomplish" æ„æ€æœ€æ¥è¿‘çš„è©ï¼š',
                    options: ['fail', 'achieve', 'begin', 'forget'],
                    correct: 1,
                    ability: 'vocabulary',
                    explanation: '"Accomplish" å’Œ "achieve" éƒ½æœ‰"å®Œæˆã€é”æˆ"çš„æ„æ€ã€‚'
                },
                {
                    type: 'comprehension',
                    level: 'B1',
                    question: 'é–±è®€æ®µè½å¾Œå›ç­”ï¼š\n"Although the weather was terrible, the concert was a huge success. Many people attended despite the rain."\nä¸»è¦æ„æ€æ˜¯ï¼š',
                    options: [
                        'å¤©æ°£å¾ˆå¥½ï¼ŒéŸ³æ¨‚æœƒå¾ˆæˆåŠŸ',
                        'å¤©æ°£å¾ˆç³Ÿï¼ŒéŸ³æ¨‚æœƒå¤±æ•—äº†',
                        'å„˜ç®¡å¤©æ°£å¾ˆç³Ÿï¼ŒéŸ³æ¨‚æœƒä»ç„¶å¾ˆæˆåŠŸ',
                        'å› ç‚ºä¸‹é›¨ï¼Œå¾ˆå°‘äººåƒåŠ éŸ³æ¨‚æœƒ'
                    ],
                    correct: 2,
                    ability: 'comprehension',
                    explanation: 'é—œéµè© "Although" è¡¨ç¤ºè½‰æŠ˜ï¼Œå„˜ç®¡å¤©æ°£ç³Ÿç³•ï¼ŒéŸ³æ¨‚æœƒä¾ç„¶æˆåŠŸã€‚'
                },
                {
                    type: 'grammar',
                    level: 'B1',
                    question: 'é¸æ“‡æ­£ç¢ºçš„æ¢ä»¶å¥ï¼š',
                    options: [
                        'If I will have time, I will call you.',
                        'If I have time, I will call you.',
                        'If I had time, I will call you.',
                        'If I have time, I would call you.'
                    ],
                    correct: 1,
                    ability: 'grammar',
                    explanation: 'ç¬¬ä¸€é¡æ¢ä»¶å¥çš„çµæ§‹æ˜¯ï¼šIf + ç¾åœ¨å¼, will + å‹•è©åŸå½¢ã€‚'
                }
            ],
            
            // B2ç´šåˆ¥é¡Œç›®
            B2: [
                {
                    type: 'vocabulary',
                    level: 'B2',
                    question: 'é¸æ“‡æœ€é©åˆçš„è©èªå®Œæˆå¥å­ï¼š\n"The company decided to ___ their marketing strategy to attract younger customers."',
                    options: ['modify', 'destroy', 'ignore', 'copy'],
                    correct: 0,
                    ability: 'vocabulary',
                    explanation: '"Modify" æ„æ€æ˜¯ä¿®æ”¹ã€èª¿æ•´ï¼Œæœ€ç¬¦åˆå•†æ¥­èªå¢ƒä¸­æ”¹è®Šç­–ç•¥çš„å«ç¾©ã€‚'
                },
                {
                    type: 'reasoning',
                    level: 'B2',
                    question: 'æ ¹æ“šé‚è¼¯æ¨ç†ï¼Œé¸æ“‡æœ€åˆç†çš„çµè«–ï¼š\n"All successful entrepreneurs take risks. Maria is a successful entrepreneur. Therefore..."',
                    options: [